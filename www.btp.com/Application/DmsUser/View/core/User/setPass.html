<load href="__PUBLIC__/layer/layer.js" />
<div class="core_main User" id="setPass">
	<div class="core_title">
    	<span class="core_title_con"><span>{:L('当前位置')}</span>：{$nowtitle}</span>
    </div>
    <div class="core_con">
        <form name="form1" method="post" action="__MODULE__/User/passSave">
        <table class="tablebg">
            <!--<TR class="shuang">
                <TD width="40%"  rowspan="1" vAlign=middle  >{:L('用户编号')}:</TD>
                <TD width="60%"   rowspan="1" vAlign=middle  >{$userinfo.编号}</TD>
            </TR>
            <TR class="shuang">
                <TD width="40%"  rowspan="1" vAlign=middle  >{:L('用户名')}:</TD>
                <TD width="60%"   rowspan="1" vAlign=middle  >{$userinfo.姓名}</TD>
            </TR>-->

            <!-- 密码校验繁琐，屏蔽显示20170125
            <if condition="$pwd3Switch eq false || $pwd3Empty eq true">
            <tr  >
                <td class="tbkey">{:L('二级密码验证')}：</td>
                <td class="tbval"><input name="oldpwd2" type="password" autocomplete="off" id="oldpwd2"></td>
            </tr>
            </if>
            <if condition="$pwd3Switch eq true && $pwd3Empty eq false">
            <tr  >
                <td class="tbkey">{:L('三级密码验证')}：</td>
                <td class="tbval"><input name="oldpwd3" type="password" autocomplete="off" id="oldpwd3"></td>
            </tr>
            </if>
			-->

            <tr>
                <td class="tbkey">{:L('一级新密码')}：</td>
                <td class="tbval">
                    <input class="pass_node" name="pwd1" type="password" autocomplete="off" id="pwd1"><span class="msg">{:L('至少6位')}</span>
                    <span style="display:none" id="pwd1lv">
                        <span id="pwd1_lower" style="border-bottom: 2px solid red;display:inline-block;width:35px;text-align:center">{:L('弱')}</span>
                        <span id="pwd1_middle" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('中')}</span>
                        <span id="pwd1_high" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('强')}</span>
                    </span>
                </td>
              </tr>
            <tr>
                <td class="tbkey">{:L('确认一级新密码')}：</td>
                <td class="tbval"><input name="repwd1" type="password" autocomplete="off" id="repwd1"><span class="msg"></span></td>
            </tr>
            <!--  <TR  class="shuang">
                <TD class="tbkey"><label>原二级密码</label>:</TD>
                <TD  ><input name="oldpwd1" type="password" autocomplete="off" id="oldpwd1"></TD>
            </TR>-->
            <tr>
                <td class="tbkey">{:L('二级新密码')}：</td>
                <td class="tbval">
                    <input class="pass_node" name="pwd2" type="password" autocomplete="off" id="pwd2"><span class="msg">{:L('至少6位')}</span>
                    <span style="display:none" id="pwd2lv">
                        <span id="pwd2_lower" style="border-bottom: 2px solid red;display:inline-block;width:35px;text-align:center">{:L('弱')}</span>
                        <span id="pwd2_middle" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('中')}</span>
                        <span id="pwd2_high" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('强')}</span>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="tbkey">{:L('确认二级新密码')}：</td>
                <td class="tbval"><input name="repwd2" type="password" autocomplete="off" id="repwd2"><span class="msg"></span></td>
            </tr>
			<eq name="pwd3Switch" value="true">
			<tr>
                <td class="tbkey">{:L('三级新密码')}：</td>
                <td class="tbval">
                    <input class="pass_node" name="pwd3" type="password" autocomplete="off" id="pwd3"><span class="msg">{:L('至少6位')}</span>
                    <span style="display:none" id="pwd3lv">
                        <span id="pwd3_lower" style="border-bottom: 2px solid red;display:inline-block;width:35px;text-align:center">{:L('弱')}</span>
                        <span id="pwd3_middle" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('中')}</span>
                        <span id="pwd3_high" style="border-bottom: 2px solid #dadada;display:inline-block;width:35px;text-align:center">{:L('强')}</span>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="tbkey">{:L('确认三级新密码')}：</td>
                <td class="tbval"><input name="repwd3" type="password" autocomplete="off" id="repwd3"><span class="msg"></span></td>
            </tr>
			</eq>
            <if condition="adminshow('smsSwitch') && $verificateSwitch eq 1 and $verificatesmsContent neq ''">
             <tr>
                <td class="tbkey">{:L('短信验证码')}：</td>
                <td class="tbval">
                    <input name="repwdSms" type="text" id="repwdSms" >
                    <if condition="isset($smsif_arr['text'])">
			        	<input style="margin-left:10px" type="button" id="sendMess" class="send-msg" value="{:L('获取短信')}" onclick="first_verify()" />
			        </if>
			        <if condition="isset($smsif_arr['audio'])">
			        	<input style="margin-left:10px" type="button" id="sendAudio" class="send-msg" value="{:L('获取语音')}" onclick="first_verify()"/>
			        </if>
                </td>
            </tr>
            </if>
            <eq name="changePwdmailSwitchyanzheng" value="1">
             <tr>
                <td class="tbkey">{:L('邮件验证')}：</td>
                <td class="tbval"><input name="repwdMail" type="text" id="repwdMail" ><input style="margin-left:10px" type="button" id="sendMailMess" value="{:L('点击获取')}" /></td>
            </tr>
            </eq>
            <tr>
                <td colspan="2" ><button class="button_text button-150" type="button" onclick="tijiao()">{:L('确定')}</button></td>
            </tr>
        </table>
    </form>
    </div>
    <div class="core_page"></div>
</div>
<script>
//新密码长度,一致性，强度验证
$('input[name^="pwd"]').keyup(function(){
	var index = $(this).attr('name').charAt(3);
    var length = $('#pwd'+index).val().length;
    var pwd = $(this).val();
	var repwd = $('#repwd'+index).val();
	if(length > 5){
		$('#pwd'+index).next('.msg').html('*');
		if(repwd != '' && pwd != repwd){
			$('#repwd'+index).next('.msg').html("{:L('密码不一致')}！");
		}
		if(repwd != '' && pwd == repwd){
			$('#repwd'+index).next('.msg').html("");
		}
	}else{
		$('#pwd'+index).next('.msg').html("{:L('至少6位')}");
	}
});
function tijiao() {
    var pwd = $('input[name^=pwd]');
    var repwd = $('input[name^=repwd]');
    var pwdA = [];
    var repwdA = [];
    var flag = 0;

    pwd.each(function (i, e) {
        pwdA[i] = e;
    });
    repwd.each(function (i, e) {
        repwdA[i] = e;
    });
    for (var i=0; i<pwdA.length; i++) {
        console.log()
        if (!!pwdA[i].value) {
            if (pwdA[i].value == repwdA[i].value) {
                flag++;
            } else {
                $('#repwd'+(i+1)).next('.msg').html("{:L('密码不一致')}！");
            }
        } else {
            $('#pwd'+(i+1)).next('.msg').html("{:L('请填写密码')}！");
        }
    }
    if (flag == pwdA.length) {
        $('form').submit();
    }

    /*
    $('form').submit();
    $('input[name^="repw"]').next('.msg').html('密码不一致！');
    */
}
$('input[name^="repw"]').keyup(function () {
    var index = $(this).attr('name').charAt(5);
    var pre = $('#pwd'+index).val();
    var rep = $(this).val();
    if (pre != rep) {
        $(this).next('.msg').html("{:L('密码不一致')}！");
    } else {
        $(this).next('.msg').empty();
    }
});

<if condition="adminshow('passlv')">
$('.pass_node').keyup(function () {
    var name = $(this).attr('name');
    if(!name){
        return;
    }
    var pwd = $(this).val();
    if(!pwd){
        $(this).parents('td').find('.msg').hide(0);
        $("#state_"+name).show(0);
        return;
    }
    $(this).parents('td').find('.msg').hide(0);
    $("#"+name+"lv").show(0);

    var Mcolor = "#FFF",Lcolor = "#FFF",Hcolor = "#FFF";
    var m=0;

    var Modes = 0;
    for (i=0; i<pwd.length; i++)
    {
        var charType = 0;
        var t = pwd.charCodeAt(i);
        if (t>=48 && t <=57) // 0-9
        {
            charType = 1;
        }
        else if (t>=65 && t <=90) // A-Z
        {
            charType = 2;
        }
        else if (t>=97 && t <=122) // a-z
            charType = 3;
        else // 其他
            charType = 4;
        Modes |= charType; // 按位或赋值
    }

    for (i=0;i<4;i++)
    {
        if (Modes & 1) m++; // 按位与
        Modes>>>=1; // 无符号右移
    }

    if (pwd.length<=4)
    {
        m = 1;
    }
    // alert(m);
    switch(m)
    {
    case 1 :
        Lcolor = "2px solid red";
        Mcolor = Hcolor = "2px solid #DADADA";
        break;
    case 2 :
        Mcolor = "2px solid #f90";
        Lcolor = Hcolor = "2px solid #DADADA";
        break;
    case 3 :
        Hcolor = "2px solid #3c0";
        Lcolor = Mcolor = "2px solid #DADADA";
        break;
    case 4 :
        Hcolor = "2px solid #3c0";
        Lcolor = Mcolor = "2px solid #DADADA";
        break;
    default :
        Hcolor = Mcolor = Lcolor = "";
        break;
    }

    document.getElementById(name+"_lower").style.borderBottom  = Lcolor;
    document.getElementById(name+"_middle").style.borderBottom = Mcolor;
    document.getElementById(name+"_high").style.borderBottom   = Hcolor;

});
</if>

var mwait=300;
var msta = true;
function mtime(o) {
    if(msta == true){
        var content = '{$changePwdmailContentyanzheng}';
        $.post('__CONTROLLER__/sendMailVerify',{type:'修改密码',content: content},function(data){

            eval("var data= " + data);
            if(data.status == 1){
                layer.alert("{:L('重新发送')}！", { title: "{:L('提示')}", btn: "{:L('确定')}"});
            }else{
                mwait=0;
                layer.alert("{:L('重新发送')}！", { title: "{:L('提示')}", btn: "{:L('确定')}"});
			}
        });
        msta = false;
    }
    if (mwait == 0) {
      o.removeAttribute("disabled");
      o.value="{:L('点击获取')}";
      mwait = 300;
      msta = true;
    } else {
      o.setAttribute("disabled", true);
      o.value="{:L('重新发送')}(" + mwait + ")";
      mwait--;
      setTimeout(function() {
        mtime(o)
      },
      1000)
    }
  }
  if($("#sendMailMess").length>0)
  document.getElementById("sendMailMess").onclick=function(){mtime(this);}
</script>

<!-- 短信验证码 -->
<if condition="adminshow('smsSwitch') && $verificateSwitch eq 1 and $verificatesmsContent neq ''">
<script src="__PUBLIC__/js/sendsms.js"></script>
<script src="__PUBLIC__/layer/layer.js"></script>
<script>
var	characters	= {title:"{:L('提示')}",determ:"{:L('确定')}",clickget:"{:L('点击获取')}",resend:"{:L('重新发送')}"};
var type		= '修改密码';
var isaudio     = 0;
var smsObj;

function first_verify() {
	if($(this).attr("id") == "sendMess"){
		smsObj = $("#sendMess");
	}else{
		smsObj = $("#sendAudio");
	}
	if("{$picVerify}" === "false"){
		time(smsObj);
	}else{
    layer.open({
        type: 1,
        title:'填写验证码',
        skin: 'layui-layer-rim', //加上边框
        area: ['300px', '200px'], //宽高
        btn: ['确定'],
        yes: function(index, layero){
          //点击按钮之后，直接触发AJAX
          var postval = $("#verifyss").val();
          $.ajax({
            url:"__MODULE__/FunBank/verify_s/id/"+postval,
            type:"GET",
            dataType:"JSON",
            data:postval,
            success:function(data){
                if( data.status == 0 )
                {
                    $('#msg').html('验证码不正确');
                    var timenow = new Date().getTime();
                    $('#qqsmsverifyImg').attr('src', '__CONTROLLER__/verifyImg/adv/1/' + timenow);
                }
                else
                {
                    layer.close(index);     //关闭弹出层
                    time(smsObj);
                }
            }
            });
        },
        content: '<input id="verifyss" autocomplete="off" maxlength="4" type="text" name="verifyss" value="">'+'<img id="qqsmsverifyImg" src="__CONTROLLER__/verifyImg" onClick="smsfreshVerify(this)" border="0" alt="点击刷新验证码" ><span id="msg" style="color:red"></span>',
    });
    }
}
function smsfreshVerify() {
    //重载验证
    var timenow = new Date().getTime();
    if (type) {
        $('#qqsmsverifyImg').attr('src', '__CONTROLLER__/verifyImg/adv/1/' + timenow);
    } else {
        $('#qqsmsverifyImg').attr('src', '__CONTROLLER__/verifyImg/' + timenow);
    }
}
</script>
</if>
<!-- 短信验证码 -->