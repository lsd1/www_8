<include file="Public:header" />
<div class="content">
<!-- 这里是页面内容区 -->
	<div class="content-padded">
		<form id="search_form" action="__MODULE__/Net/disp:__XPATH__"  method="post" >
			<div class="searchbar row">
				<div class="search-input col-80">
					<label class="icon icon-search" for="search"></label>
					<input type="search" id='search' name="uid" placeholder="{:L('请输入你在网络图中的账户')}"/>
				</div>
				<a id="submit" class="button button-fill button-primary col-20">{:L('搜索')}</a>
			</div>
			<if condition="$firstUserInfo['编号'] neq $thisUser['编号']">
			<p class="buttons-row">
				<a class="button button-round" href="__MODULE__/Net/disp:__XPATH__/uid/{:$firstUserInfo[$netNode->name.'_上级编号']}">{:L('上一层')}</a>
				<a class="button button-round" href="__MODULE__/Net/disp:__XPATH__">{:L('置顶')}</a>
			</p>
			</if>
		</form>
	</div>
	<p>
		<div class="net-title" id="network_link">
			{$firstUserInfo['编号']}
		</div>
	</p>
	<div class="tree" id="sponsor_tree">
		<ul role="tree">
			<li id="leader" class="parent_li" role="treeitem">
				<span class="button" title="Collapse this branch">
					<i class="ion ion-person-stalker"></i>
					<b>{$firstUserInfo.编号}</b>
				</span>
				<br>
				<small style="color:#3276b1"><if condition="$firstUserInfo['姓名']" >{$firstUserInfo.姓名}<else/>{:L('暂无')}</if></small>
				<small>
				<if condition="$treenumArr neq ''">
					<br>
					<small>
					<foreach name="treenumArr" item="treenum" key="netname">
					{:$firstUserInfo[$treenum.'本日']}|{:$firstUserInfo[$treenum.'累计']}
					</foreach>
					</small>
					</if>
				{// 向下递归遍历网络图的所有子节点 }
				{:print_tree(0,$netTree,$netPlaceName,$firstUserInfo,$netName,$levelsArr,$thisUser,$netNode,$treenumArr)}

			   <php>
				//递归遍历网络图函数
				function print_tree($layer,$netTree,$netPlaceName,$parent,$netName,$levelsArr,$thisUser,$netNode,$treenumArr) {
				$j = M('会员')->where(array($netName.'_上级编号'=>$parent['编号']))->count();
				if(empty($netTree[$layer]) || $j == 0) return;
					</php>
				<ul role="group">
				<php>
				$i=0;
				//$j= $parent[$netName.'_推荐人数'];
				foreach($netTree[$layer] as $key=>$val){
					if($val[$netName.'_上级编号'] === $parent['编号']){
						$userInfo = $val;
					}else{
						continue;
					}
					$i++;
				</php>
				<notempty name="userInfo">
				<li id="tree_{$userInfo['编号']}">
					<span data-id="{$userInfo['编号']}" class="button open_tree">
						<i class="ion"></i>
                        <if condition="$netNode:shopNetDisp eq 1 and $thisUser['服务中心'] eq 0">{$userInfo['编号']}<else /><a href="__MODULE__/Net/disp:__XPATH__/uid/{$userInfo['编号']}"><strong>{$userInfo['编号']}</strong></a></if>
					</span>
					<br>
					<small style="color:#3276b1"><if condition="$userInfo['姓名']" >{$userInfo.姓名}<else/>{:L('暂无')}</if></small>
					<if condition="$treenumArr neq ''">
					<small>
					<foreach name="treenumArr" item="treenum" key="netname">
					{:$userInfo[$treenum.'本日']}|{:$userInfo[$treenum.'累计']}
					</foreach>
					</small>
					</if>
					{// 向下递归遍历网络图的所有子节点 }
					{:print_tree($layer+1,$netTree,$netPlaceName,$userInfo,$netName,$levelsArr,$thisUser,$netNode,$treenumArr)}
				</li>
				</notempty>
				<php>}</php>
				 </ul>
				<php>$layer++;}</php>
			</li>
		</ul>
	</div>
</div>
<include file="Public:footer" />

<script type="text/javascript">
	// do not remove : global functions!
var tree_id = "";

var Get_tree_data = function(id , e) {
    Set_tree(1, id , e);
}

function Set_tree(data, u_id , e) {
    var tree_obj = $("#sponsor_tree");
    var html = "";
    network_init(e);
}

// PAGE RELATED SCRIPTS
var network_init = function(e) {
    $('.tree > ul').attr('role', 'tree').find('ul').attr('role', 'group');
    $(e).parent('li').addClass('parent_li').attr('role', 'treeitem').children('span').attr('title', 'Collapse this branch').on('click', function(e) {
        var children = $(this).parent('li.parent_li').children('ul').children('li');
        children.toggle();
        $(this).children('.ion').toggleClass('ion-person-stalker');
        e.stopPropagation();
    });
    $("#submit").click(function(){
        $('#search_form').submit();
    });
}

$(document).on("click", ".open_tree", function() {
	var id = $(this).data("id");
	Get_tree_data(id , this);
})

$("#Back_tree_view").click(function() {
    $.modal({text: 11,buttons: [{text: "{:L('确定')}"}]});
	Get_tree_data(tree_id);
})

Get_tree_data("",$("#leader>span"));
</script>
